[TOC]

# iot期末项目

## 项目要求

- 收集并上传环境光传感器的测量数据到服务器
- 收集并上传开发板(开/关)上的LED状态到服务器
- 实现一个web页面/移动应用程序/微信迷你程序，要求如下:

1. 可视化环境光传感器的测量
2. 控制LED有两种模式: 在远程应用程序上切换这两种模式

- 手动模式:在远程应用上手动控制LED的开关
- 自动模式:根据环境测量值控制LED的开关光传感器。当测量值低于50勒克斯时打开LED，当测量值低于50勒克斯时关闭LED

## 架构

![架构](./image/架构.png)

​	系统由web前端，web服务器，mqtt服务器，边缘设备组成。web前端负责数据的可视化，以及控制组件，采用http协议与web服务器进行通信。web服务器负责接收前端发送来的指令，之后转成mqtt协议与mqtt服务器进行通信，mqtt服务器则负责边缘设备与web服务器的订阅发布，达到控制边缘设备的效果。



## 前端

前端部分主要分为2部分，数据可视化部分与设备操控部分。

### 设备操控部分

![前端2](./image/前端2.png)

​	这部分主要是用于操控边缘设备以及显示设备状态，主要显示状态有灯的暗灭，和当前模式。可以修改灯的状态和模式，如果是自动模式，则会报“模式为自动模式，无法修改”。

![前端4](./image/前端4.png)

### 数据可视化部分

![前端1](./image/前端1.png)



![前端3](./image/前端3.png)

可以动态展示当前灯光信息，包括表格部分和图像部分。





## 服务器端

### web服务器端

web服务器端采用java语言编写，使用springboot+mybatis框架开发，数据库选择mysql。

#### 数据库

数据库使用mysql存储设备的历史记录，er图如下：

![数据库](./image/数据库.png)

- led_state：存储当前设备的状态。
- led_mode：存储当前设备的模式。
- brightness_record：存储当前设备的亮度记录。

#### 服务层设计架构

![1577124471245](./image/服务端.png)

- view层：负责推送html界面。
- controler层：负责与前端接口通信。
- service层：处理业务逻辑。
- mapper层：与数据库的映射。
- dto层：存储java bean对象。
- mqttUtil包：负责与mqtt服务器通信。

#### 通信接口

地址与端口：129.226.168.220:8081

**/led/get_state**

get请求，获取led灯状态

后端

```json
{
    state:0或1
}
```



**/led/modify_state**

post请求，修改led灯状态

前端

```json
{
    state:0或1
}
```

后端

```json
{
    state:0或1
    message:修改成功或失败
}
```



**/record/get_record**

post请求，分页获取记录

前端

```json
{
    page:1 //第几页
    volume:10 //每页容量
}
```

后端

```json
[
    {
    	记录对象1
	},
    {
    	记录对象2
	},
]
```

**/mode/get_mode**

get请求，获取状态信息

后端

```json
{
    state:1或2（1为手动模式，2为自动模式）
}
```



**/mode/modify_mode**

post请求，修改状态信息

前端

```json
{
    state:1或2（1为手动模式，2为自动模式）
}
```

后端

```json
{
    state:0或1
    message:修改成功或失败
}
```

### mqtt服务器端

mqtt采用业界主流的mqtt服务器EMQX服务器进行搭建，主要发布的主题如下：

- light：硬件往这个topic发布环境中的灯光信息，直接传string值
- ledh：硬件往这个topic发布led灯的暗灭信息，0为关灯，1为开灯
- mode：服务器往这个topic发布指令，1为手动模式，2为自动模式。
- leds：服务器往这个topic发布指令，如果硬件为手动模式，0为关灯，1为开灯。

## 设备端

